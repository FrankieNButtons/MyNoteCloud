# PaperMC 1.20.4（尽量原版体验）服务端在 Linux 上的安装与运维

目标：Paper 1.20.4（兼容 Vanilla 客户端），尽量保持原版体验（不装改变玩法的插件，仅做性能/管理）。

> 说明
> - Paper 1.20.4 需要 **Java 17**（建议 Temurin/OpenJDK 17）。
> - 下面默认使用 `systemd`、单独用户 `minecraft`、目录 `/opt/minecraft/paper-1.20.4`。
> - **不会自动执行破坏性操作**；脚本会提示你确认。

---

## 0. 预备：安装 Java 17 与基础工具

### Debian/Ubuntu
```bash
sudo apt update
sudo apt install -y openjdk-17-jre-headless curl jq tmux
java -version
```

### RHEL/CentOS/Rocky/Alma
```bash
sudo dnf install -y java-17-openjdk-headless curl jq tmux
java -version
```

---

## 1. 创建专用用户与目录（推荐）

```bash
sudo useradd --system --home /opt/minecraft --create-home --shell /usr/sbin/nologin minecraft

# 目录规划
sudo mkdir -p /opt/minecraft/paper-1.20.4
sudo chown -R minecraft:minecraft /opt/minecraft/paper-1.20.4
```

> 如你已有 `minecraft` 用户/目录，请相应调整。

---

## 2. 下载 Paper 1.20.4 最新构建

Paper 提供官方 API，可自动取最新 build：

```bash
cd /opt/minecraft/paper-1.20.4

# 取最新 build
BUILD=$(curl -fsSL https://api.papermc.io/v2/projects/paper/versions/1.20.4 | jq -r '.builds[-1]')

# 下载 jar（保存在 paper.jar）
sudo -u minecraft bash -lc "cd /opt/minecraft/paper-1.20.4 && curl -fL -o paper.jar https://api.papermc.io/v2/projects/paper/versions/1.20.4/builds/${BUILD}/downloads/paper-1.20.4-${BUILD}.jar"

# 验证文件
ls -lh /opt/minecraft/paper-1.20.4/paper.jar
```

---

## 3. 首次启动以生成文件，并同意 EULA

先手动跑一次，让它生成 `eula.txt`、`server.properties` 等：

```bash
sudo -u minecraft bash -lc "cd /opt/minecraft/paper-1.20.4 && java -Xms1G -Xmx2G -jar paper.jar nogui" 
```

它会提示需要同意 EULA，退出后：

```bash
sudo -u minecraft bash -lc "cd /opt/minecraft/paper-1.20.4 && sed -i 's/eula=false/eula=true/' eula.txt"
```

然后再启动一次确认能正常进入：

```bash
sudo -u minecraft bash -lc "cd /opt/minecraft/paper-1.20.4 && java -Xms1G -Xmx2G -jar paper.jar nogui" 
```

> 停服：在控制台输入 `stop`。

---

## 4. 尽量原版体验：建议的基础配置

### 4.1 `server.properties`
- `online-mode=true`（正版验证，默认 true）
- `difficulty=normal`、`gamemode=survival`
- `view-distance` / `simulation-distance`：人多时适当降低

编辑（并把端口改为 25566）：
```bash
sudo -u minecraft nano /opt/minecraft/paper-1.20.4/server.properties
# 确保包含：server-port=25566
```

### 4.2 Paper 配置（不改变玩法的性能项）
Paper 配置通常在 `config/paper-global.yml`（新版本结构）及 `config/paper-world-defaults.yml`。

常见“尽量不改变玩法”的做法：
- 不装影响机制的插件
- 仅做合理的性能参数（例如：`max-entity-collisions`、tick 限制等谨慎调整）

> 具体项随 Paper 版本变化较快，建议先跑一段时间，观察 TPS/Timings 再微调。

---

## 5. 生成 systemd 服务（开机自启、后台运行）

### 5.1 创建启动脚本（推荐）
把 JVM 参数集中在脚本里，后续调整更方便。

脚本路径：`/opt/minecraft/paper-1.20.4/start.sh`

示例内容（Aikar flags，Java 17 常用）：
```bash
#!/usr/bin/env bash
set -euo pipefail

cd /opt/minecraft/paper-1.20.4

# 内存：按机器情况调整
XMS=2G
XMX=4G

JAVA=java

# Aikar flags（Paper/Spigot 常用）
FLAGS=(
  -Xms${XMS}
  -Xmx${XMX}
  -XX:+UseG1GC
  -XX:+ParallelRefProcEnabled
  -XX:MaxGCPauseMillis=200
  -XX:+UnlockExperimentalVMOptions
  -XX:+DisableExplicitGC
  -XX:+AlwaysPreTouch
  -XX:G1NewSizePercent=30
  -XX:G1MaxNewSizePercent=40
  -XX:G1HeapRegionSize=8M
  -XX:G1ReservePercent=20
  -XX:G1HeapWastePercent=5
  -XX:G1MixedGCCountTarget=4
  -XX:InitiatingHeapOccupancyPercent=15
  -XX:G1MixedGCLiveThresholdPercent=90
  -XX:G1RSetUpdatingPauseTimePercent=5
  -XX:SurvivorRatio=32
  -XX:+PerfDisableSharedMem
  -XX:MaxTenuringThreshold=1
)

exec ${JAVA} "${FLAGS[@]}" -jar paper.jar nogui
```

创建并授权：
```bash
sudo -u minecraft bash -lc "cat > /opt/minecraft/paper-1.20.4/start.sh" <<'EOF'
#!/usr/bin/env bash
set -euo pipefail
cd /opt/minecraft/paper-1.20.4
XMS=2G
XMX=4G
JAVA=java
FLAGS=(
  -Xms${XMS}
  -Xmx${XMX}
  -XX:+UseG1GC
  -XX:+ParallelRefProcEnabled
  -XX:MaxGCPauseMillis=200
  -XX:+UnlockExperimentalVMOptions
  -XX:+DisableExplicitGC
  -XX:+AlwaysPreTouch
  -XX:G1NewSizePercent=30
  -XX:G1MaxNewSizePercent=40
  -XX:G1HeapRegionSize=8M
  -XX:G1ReservePercent=20
  -XX:G1HeapWastePercent=5
  -XX:G1MixedGCCountTarget=4
  -XX:InitiatingHeapOccupancyPercent=15
  -XX:G1MixedGCLiveThresholdPercent=90
  -XX:G1RSetUpdatingPauseTimePercent=5
  -XX:SurvivorRatio=32
  -XX:+PerfDisableSharedMem
  -XX:MaxTenuringThreshold=1
)
exec ${JAVA} "${FLAGS[@]}" -jar paper.jar nogui
EOF

sudo -u minecraft chmod +x /opt/minecraft/paper-1.20.4/start.sh
```

### 5.2 systemd unit
创建 `/etc/systemd/system/minecraft-paper.service`：

```ini
[Unit]
Description=Minecraft Paper 1.20.4 Server
After=network.target

[Service]
Type=simple
User=minecraft
Group=minecraft
WorkingDirectory=/opt/minecraft/paper-1.20.4
ExecStart=/opt/minecraft/paper-1.20.4/start.sh
Restart=on-failure
RestartSec=10

# 尽量不影响本机其它服务（例如 OpenClaw）：给 MC 进程一点“让路”
Nice=5
CPUWeight=80
IOWeight=80
# 你也可以按机器内存加一个硬上限（示例 6G）：
# MemoryMax=6G

# 更安全一些（如需写更多目录请相应放开）
NoNewPrivileges=true
PrivateTmp=true
ProtectSystem=strict
ProtectHome=true
ReadWritePaths=/opt/minecraft/paper-1.20.4

# 打开文件数（玩家多/插件多可调大）
LimitNOFILE=100000

[Install]
WantedBy=multi-user.target
```

写入并启用：
```bash
sudo tee /etc/systemd/system/minecraft-paper.service > /dev/null <<'EOF'
[Unit]
Description=Minecraft Paper 1.20.4 Server
After=network.target

[Service]
Type=simple
User=minecraft
Group=minecraft
WorkingDirectory=/opt/minecraft/paper-1.20.4
ExecStart=/opt/minecraft/paper-1.20.4/start.sh
Restart=on-failure
RestartSec=10
NoNewPrivileges=true
PrivateTmp=true
ProtectSystem=strict
ProtectHome=true
ReadWritePaths=/opt/minecraft/paper-1.20.4
LimitNOFILE=100000

[Install]
WantedBy=multi-user.target
EOF

sudo systemctl daemon-reload
sudo systemctl enable --now minecraft-paper.service
sudo systemctl status minecraft-paper.service --no-pager
```

日志：
```bash
journalctl -u minecraft-paper.service -f
```

---

## 6. 端口与防火墙

默认端口：`25566/tcp`.

你需要在 `server.properties` 里设置：
```properties
server-port=25566
```

### UFW（Ubuntu 常见）
```bash
sudo ufw allow 25566/tcp
sudo ufw status
```

### firewalld（RHEL 常见）
```bash
sudo firewall-cmd --permanent --add-port=25566/tcp
sudo firewall-cmd --reload
sudo firewall-cmd --list-ports
```

如果你在云服务器，还需要在云厂商安全组放行该端口。

### 6.1 常见问题：游戏里“局域网游戏”扫不到服务器
这是正常现象：**专用服务器通常不会出现在“局域网游戏”自动发现列表里**（那个更偏向单机开局域网时的广播发现）。

正确连接方式：
- 进游戏 → **多人游戏** → **直接连接**
- 输入：`<这台服务器的IP>:25566`
  - 同一台机器本机连：`127.0.0.1:25566`
  - 同一局域网其他电脑：例如 `192.168.x.x:25566`

如果你看到服务端日志里仍然是 `Starting Minecraft server on *:25565`，说明端口还没改成功：
1) 编辑 `server.properties`：确保有 `server-port=25566`
2) **重启服务端**（停服再开）

快速自检（在服务器上跑）：
```bash
# 看服务端到底监听了哪个端口
sudo ss -ltnp | grep java || true

# 看 server.properties 端口设置
sudo -u minecraft grep -n '^server-port' /opt/minecraft/paper-1.20.4/server.properties || true
```

> 另外请确保 `server.properties` 里的 `server-ip=` 为空（不要绑定到错误 IP），除非你明确知道自己在做什么。

---

## 7. 备份流程（推荐）

### 最稳妥：停服备份
```bash
sudo systemctl stop minecraft-paper.service
sudo tar -C /opt/minecraft -czf /opt/minecraft/backups/paper-1.20.4-$(date +%F-%H%M).tar.gz paper-1.20.4
sudo systemctl start minecraft-paper.service
```

创建备份目录：
```bash
sudo mkdir -p /opt/minecraft/backups
sudo chown -R minecraft:minecraft /opt/minecraft/backups
```

> 若要不停服热备份，需要 RCON/控制台执行 `save-all`、`save-off` 等并确保一致性；这里给出的是“可靠优先”的停服备份。

---

## 8. 更新 Paper（同版本 1.20.4 的新构建）

流程（安全优先）：
1) 备份
2) 停服
3) 下载新 jar 覆盖 `paper.jar`（或保留旧版本）
4) 启服

命令示例：
```bash
# 1) 停服
sudo systemctl stop minecraft-paper.service

# 2) 备份 jar（可选）
sudo -u minecraft bash -lc "cd /opt/minecraft/paper-1.20.4 && cp -a paper.jar paper.jar.$(date +%F-%H%M)"

# 3) 下载最新 build
BUILD=$(curl -fsSL https://api.papermc.io/v2/projects/paper/versions/1.20.4 | jq -r '.builds[-1]')
sudo -u minecraft bash -lc "cd /opt/minecraft/paper-1.20.4 && curl -fL -o paper.jar https://api.papermc.io/v2/projects/paper/versions/1.20.4/builds/${BUILD}/downloads/paper-1.20.4-${BUILD}.jar"

# 4) 启服
sudo systemctl start minecraft-paper.service
```

---

## 9. 常用运维命令

```bash
# 启停/重启
sudo systemctl start minecraft-paper.service
sudo systemctl stop minecraft-paper.service
sudo systemctl restart minecraft-paper.service

# 查看状态
sudo systemctl status minecraft-paper.service --no-pager

# 跟踪日志
journalctl -u minecraft-paper.service -f
```

---

## 10. 复用脚本

本目录同时提供可复用脚本（不会自动跑 sudo 破坏性操作，执行前会提示）：
- `scripts/install_paper_1.20.4.sh`
- `scripts/update_paper_1.20.4.sh`
- `scripts/backup_paper.sh`

用法见各脚本顶部注释。
